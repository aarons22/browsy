---
phase: 04-book-info-actions
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - androidApp/src/main/java/com/browsy/android/ui/info/BookInfoBottomSheet.kt
  - androidApp/src/main/java/com/browsy/android/ui/info/ShelfViewModel.kt
  - androidApp/src/main/java/com/browsy/android/ui/feed/BookFeedScreen.kt
autonomous: false

must_haves:
  truths:
    - "User can tap book cover to see info panel"
    - "Info panel shows title, author, description, pub date, genres"
    - "User can tap TBR button to save book"
    - "User can tap Recommend button to recommend book"
    - "User can tap Read button to mark as read"
    - "User can tap Buy button to see purchase options"
    - "Visual feedback shows when book is already on shelf"
  artifacts:
    - path: "androidApp/src/main/java/com/browsy/android/ui/info/BookInfoBottomSheet.kt"
      provides: "Modal bottom sheet with book info and action buttons"
      min_lines: 80
    - path: "androidApp/src/main/java/com/browsy/android/ui/info/ShelfViewModel.kt"
      provides: "Shelf state management for action buttons"
  key_links:
    - from: "BookFeedScreen"
      to: "BookInfoBottomSheet"
      via: "ModalBottomSheet composable"
      pattern: "ModalBottomSheet"
    - from: "BookInfoBottomSheet"
      to: "LocalBookShelfRepository"
      via: "ShelfViewModel"
      pattern: "ShelfViewModel"
---

<objective>
Implement Android book info panel and shelf actions.

Purpose: Enable Android users to tap a book cover, see full details, and save books to TBR/Recommend/Read shelves with local persistence.

Output: BookInfoBottomSheet composable with modal presentation, integrated action buttons, and visual feedback for saved books.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Plan 01 provides shelf storage
@.planning/phases/04-book-info-actions/04-01-PLAN.md

# Prior Android implementation
@.planning/phases/03-core-ui-main-feed/03-02-SUMMARY.md

# Current Android files
@androidApp/src/main/java/com/browsy/android/ui/feed/BookFeedScreen.kt
@androidApp/src/main/java/com/browsy/android/ui/feed/FeedViewModel.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ShelfViewModel for shelf state management</name>
  <files>androidApp/src/main/java/com/browsy/android/ui/info/ShelfViewModel.kt</files>
  <action>
    Create ShelfViewModel extending ViewModel to manage shelf state for a book:
    ```kotlin
    package com.browsy.android.ui.info

    import androidx.lifecycle.ViewModel
    import com.browsy.data.model.BookShelf
    import com.browsy.data.repository.LocalBookShelfRepository
    import kotlinx.coroutines.flow.MutableStateFlow
    import kotlinx.coroutines.flow.StateFlow
    import kotlinx.coroutines.flow.asStateFlow

    class ShelfViewModel : ViewModel() {
        private val repository = LocalBookShelfRepository()

        private val _isOnTBR = MutableStateFlow(false)
        val isOnTBR: StateFlow<Boolean> = _isOnTBR.asStateFlow()

        private val _isOnRecommend = MutableStateFlow(false)
        val isOnRecommend: StateFlow<Boolean> = _isOnRecommend.asStateFlow()

        private val _isRead = MutableStateFlow(false)
        val isRead: StateFlow<Boolean> = _isRead.asStateFlow()

        fun loadState(bookId: String) {
            _isOnTBR.value = repository.isOnShelf(bookId, BookShelf.TBR)
            _isOnRecommend.value = repository.isOnShelf(bookId, BookShelf.RECOMMEND)
            _isRead.value = repository.isOnShelf(bookId, BookShelf.READ)
        }

        fun toggleTBR(bookId: String) {
            if (_isOnTBR.value) {
                repository.removeFromShelf(bookId, BookShelf.TBR)
            } else {
                repository.addToShelf(bookId, BookShelf.TBR)
            }
            _isOnTBR.value = !_isOnTBR.value
        }

        fun toggleRecommend(bookId: String) {
            if (_isOnRecommend.value) {
                repository.removeFromShelf(bookId, BookShelf.RECOMMEND)
            } else {
                repository.addToShelf(bookId, BookShelf.RECOMMEND)
            }
            _isOnRecommend.value = !_isOnRecommend.value
        }

        fun toggleRead(bookId: String) {
            if (_isRead.value) {
                repository.removeFromShelf(bookId, BookShelf.READ)
            } else {
                repository.addToShelf(bookId, BookShelf.READ)
            }
            _isRead.value = !_isRead.value
        }
    }
    ```
  </action>
  <verify>./gradlew :androidApp:compileDebugKotlin succeeds</verify>
  <done>ShelfViewModel manages shelf state with toggle actions</done>
</task>

<task type="auto">
  <name>Task 2: Create BookInfoBottomSheet composable</name>
  <files>androidApp/src/main/java/com/browsy/android/ui/info/BookInfoBottomSheet.kt</files>
  <action>
    Create BookInfoBottomSheet as a modal bottom sheet (following wireframe design):
    ```kotlin
    package com.browsy.android.ui.info

    import android.content.Intent
    import android.net.Uri
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.rememberScrollState
    import androidx.compose.foundation.shape.RoundedCornerShape
    import androidx.compose.foundation.verticalScroll
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.filled.Favorite
    import androidx.compose.material.icons.filled.FavoriteBorder
    import androidx.compose.material.icons.filled.Star
    import androidx.compose.material.icons.filled.StarBorder
    import androidx.compose.material.icons.filled.Check
    import androidx.compose.material.icons.filled.CheckCircle
    import androidx.compose.material.icons.filled.ShoppingCart
    import androidx.compose.material3.*
    import androidx.compose.runtime.*
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.draw.clip
    import androidx.compose.ui.layout.ContentScale
    import androidx.compose.ui.platform.LocalContext
    import androidx.compose.ui.unit.dp
    import androidx.lifecycle.viewmodel.compose.viewModel
    import coil.compose.AsyncImage
    import com.browsy.data.model.Book
    import java.net.URLEncoder

    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun BookInfoBottomSheet(
        book: Book,
        onDismiss: () -> Unit,
        sheetState: SheetState = rememberModalBottomSheetState(),
        shelfViewModel: ShelfViewModel = viewModel()
    ) {
        val context = LocalContext.current
        val isOnTBR by shelfViewModel.isOnTBR.collectAsState()
        val isOnRecommend by shelfViewModel.isOnRecommend.collectAsState()
        val isRead by shelfViewModel.isRead.collectAsState()

        LaunchedEffect(book.id) {
            shelfViewModel.loadState(book.id)
        }

        ModalBottomSheet(
            onDismissRequest = onDismiss,
            sheetState = sheetState
        ) {
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .verticalScroll(rememberScrollState())
                    .padding(horizontal = 24.dp)
                    .padding(bottom = 32.dp)
            ) {
                // Cover image centered
                book.coverUrl?.let { url ->
                    AsyncImage(
                        model = url,
                        contentDescription = "Cover of ${book.title}",
                        contentScale = ContentScale.Fit,
                        modifier = Modifier
                            .height(200.dp)
                            .fillMaxWidth()
                            .clip(RoundedCornerShape(8.dp))
                    )
                    Spacer(modifier = Modifier.height(16.dp))
                }

                // Title
                Text(
                    text = book.title,
                    style = MaterialTheme.typography.titleLarge
                )
                Spacer(modifier = Modifier.height(4.dp))

                // Author
                Text(
                    text = book.author,
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
                Spacer(modifier = Modifier.height(8.dp))

                // Pub date
                book.publishedDate?.let {
                    Text(
                        text = "Published: $it",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }

                // Genres
                if (book.subjects.isNotEmpty()) {
                    Text(
                        text = book.subjects.take(3).joinToString(" â€¢ "),
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }

                Spacer(modifier = Modifier.height(16.dp))

                // Description
                book.description?.let {
                    Text(
                        text = it,
                        style = MaterialTheme.typography.bodyMedium
                    )
                    Spacer(modifier = Modifier.height(24.dp))
                }

                // Action buttons 2x2 grid
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    ActionButton(
                        title = "TBR",
                        icon = if (isOnTBR) Icons.Filled.Favorite else Icons.Filled.FavoriteBorder,
                        isActive = isOnTBR,
                        modifier = Modifier.weight(1f)
                    ) {
                        shelfViewModel.toggleTBR(book.id)
                    }
                    ActionButton(
                        title = "Recommend",
                        icon = if (isOnRecommend) Icons.Filled.Star else Icons.Filled.StarBorder,
                        isActive = isOnRecommend,
                        modifier = Modifier.weight(1f)
                    ) {
                        shelfViewModel.toggleRecommend(book.id)
                    }
                }
                Spacer(modifier = Modifier.height(12.dp))
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    ActionButton(
                        title = "Read",
                        icon = if (isRead) Icons.Filled.CheckCircle else Icons.Filled.Check,
                        isActive = isRead,
                        modifier = Modifier.weight(1f)
                    ) {
                        shelfViewModel.toggleRead(book.id)
                    }
                    ActionButton(
                        title = "Buy",
                        icon = Icons.Filled.ShoppingCart,
                        isActive = false,
                        modifier = Modifier.weight(1f)
                    ) {
                        val query = URLEncoder.encode("${book.title} ${book.author}", "UTF-8")
                        val intent = Intent(Intent.ACTION_VIEW, Uri.parse("https://www.amazon.com/s?k=$query"))
                        context.startActivity(intent)
                    }
                }
            }
        }
    }

    @Composable
    private fun ActionButton(
        title: String,
        icon: androidx.compose.ui.graphics.vector.ImageVector,
        isActive: Boolean,
        modifier: Modifier = Modifier,
        onClick: () -> Unit
    ) {
        Button(
            onClick = onClick,
            modifier = modifier.height(64.dp),
            colors = ButtonDefaults.buttonColors(
                containerColor = if (isActive)
                    MaterialTheme.colorScheme.primaryContainer
                else
                    MaterialTheme.colorScheme.surfaceVariant
            ),
            shape = RoundedCornerShape(12.dp)
        ) {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                Icon(
                    imageVector = icon,
                    contentDescription = title,
                    tint = if (isActive)
                        MaterialTheme.colorScheme.primary
                    else
                        MaterialTheme.colorScheme.onSurfaceVariant
                )
                Spacer(modifier = Modifier.height(4.dp))
                Text(
                    text = title,
                    style = MaterialTheme.typography.labelSmall,
                    color = if (isActive)
                        MaterialTheme.colorScheme.primary
                    else
                        MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
        }
    }
    ```
  </action>
  <verify>./gradlew :androidApp:compileDebugKotlin succeeds</verify>
  <done>BookInfoBottomSheet displays book details with 4 action buttons</done>
</task>

<task type="auto">
  <name>Task 3: Wire BookInfoBottomSheet into BookFeedScreen with tap gesture</name>
  <files>androidApp/src/main/java/com/browsy/android/ui/feed/BookFeedScreen.kt</files>
  <action>
    Update BookFeedScreen and BookCoverPage to show BookInfoBottomSheet when user taps a book cover:

    1. Add state for selected book and sheet visibility in BookFeedScreen:
    ```kotlin
    var selectedBook by remember { mutableStateOf<Book?>(null) }
    var showInfoSheet by remember { mutableStateOf(false) }
    ```

    2. Pass onBookClick callback to BookCoverPage:
    ```kotlin
    BookCoverPage(
        book = books[page],
        onBookClick = {
            selectedBook = books[page]
            showInfoSheet = true
        },
        modifier = Modifier.fillMaxSize()
    )
    ```

    3. Add ModalBottomSheet at the end of BookFeedScreen composable:
    ```kotlin
    if (showInfoSheet && selectedBook != null) {
        BookInfoBottomSheet(
            book = selectedBook!!,
            onDismiss = {
                showInfoSheet = false
                selectedBook = null
            }
        )
    }
    ```

    4. Update BookCoverPage signature to accept onBookClick:
    ```kotlin
    @Composable
    fun BookCoverPage(
        book: Book,
        onBookClick: () -> Unit,
        modifier: Modifier = Modifier
    )
    ```

    5. Add clickable modifier to the Box in BookCoverPage:
    ```kotlin
    Box(modifier = modifier.clickable { onBookClick() }) {
        // ... existing content
    }
    ```

    6. Update the FAB to use ShelfViewModel for visual state:
    - Create shelfViewModel: ShelfViewModel = viewModel() in BookCoverPage
    - Call LaunchedEffect(book.id) { shelfViewModel.loadState(book.id) }
    - Use shelfViewModel.isOnTBR.collectAsState() for icon state
    - Use shelfViewModel.toggleTBR(book.id) on FAB click

    Add necessary imports:
    - androidx.compose.foundation.clickable
    - com.browsy.android.ui.info.BookInfoBottomSheet
    - com.browsy.android.ui.info.ShelfViewModel
  </action>
  <verify>./gradlew :androidApp:assembleDebug succeeds</verify>
  <done>Tap on book cover opens info sheet, TBR FAB shows saved state</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Android book info panel with TBR/Recommend/Read/Buy actions</what-built>
  <how-to-verify>
    1. Build and run Android app: ./gradlew :androidApp:installDebug (or use Android Studio)
    2. Ensure you have a valid Google Books API key in FeedViewModel.kt
    3. Wait for books to load in the feed
    4. Tap on a book cover - bottom sheet should slide up
    5. Verify bottom sheet shows:
       - Book cover (smaller, centered)
       - Title and author
       - Description (if available)
       - 4 action buttons in 2x2 grid (TBR, Recommend, Read, Buy)
    6. Tap TBR button - should toggle to filled heart, button highlights
    7. Dismiss sheet (swipe down or tap outside), scroll to different book, come back - TBR state persists
    8. Tap Buy button - should open Amazon search in browser
    9. In feed, the FAB on a TBR'd book should show filled heart state
    10. Force quit and reopen app - TBR books should still show filled hearts
  </how-to-verify>
  <resume-signal>Type "approved" if Android book info works correctly, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ./gradlew :androidApp:assembleDebug succeeds
- [ ] Tap on book cover shows bottom sheet
- [ ] Bottom sheet displays all book metadata
- [ ] All 4 action buttons are visible and tappable
- [ ] TBR/Recommend/Read buttons toggle state visually
- [ ] Buy button opens Amazon search
- [ ] TBR state persists in feed FAB
- [ ] TBR state persists across app restarts
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Human verified Android info panel works correctly
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/04-book-info-actions/04-03-SUMMARY.md`
</output>
