---
phase: 04-book-info-actions
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - iosApp/iosApp/BookInfoSheet.swift
  - iosApp/iosApp/BookFeedView.swift
  - iosApp/iosApp/FeedViewModel.swift
  - iosApp/iosApp/ShelfViewModel.swift
autonomous: false

must_haves:
  truths:
    - "User can tap book cover to see info panel"
    - "Info panel shows title, author, description, pub date, genres"
    - "User can tap TBR button to save book"
    - "User can tap Recommend button to recommend book"
    - "User can tap Read button to mark as read"
    - "User can tap Buy button to see purchase options"
    - "Visual feedback shows when book is already on shelf"
  artifacts:
    - path: "iosApp/iosApp/BookInfoSheet.swift"
      provides: "Slide-up detail panel with book info and action buttons"
      min_lines: 80
    - path: "iosApp/iosApp/ShelfViewModel.swift"
      provides: "Shelf state management for action buttons"
  key_links:
    - from: "BookFeedView"
      to: "BookInfoSheet"
      via: "sheet modifier with binding"
      pattern: "\\.sheet.*BookInfoSheet"
    - from: "BookInfoSheet"
      to: "LocalBookShelfRepository"
      via: "ShelfViewModel"
      pattern: "ShelfViewModel"
---

<objective>
Implement iOS book info panel and shelf actions.

Purpose: Enable iOS users to tap a book cover, see full details, and save books to TBR/Recommend/Read shelves with local persistence.

Output: BookInfoSheet with slide-up presentation, integrated action buttons, and visual feedback for saved books.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Plan 01 provides shelf storage
@.planning/phases/04-book-info-actions/04-01-PLAN.md

# Prior iOS implementation
@.planning/phases/03-core-ui-main-feed/03-01-SUMMARY.md

# Current iOS files
@iosApp/iosApp/BookFeedView.swift
@iosApp/iosApp/FeedViewModel.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ShelfViewModel for shelf state management</name>
  <files>iosApp/iosApp/ShelfViewModel.swift</files>
  <action>
    Create ShelfViewModel as ObservableObject to manage shelf state for a book:
    ```swift
    import SwiftUI
    import shared

    @MainActor
    class ShelfViewModel: ObservableObject {
        private let repository: LocalBookShelfRepository

        @Published var isOnTBR: Bool = false
        @Published var isOnRecommend: Bool = false
        @Published var isRead: Bool = false

        init(repository: LocalBookShelfRepository = LocalBookShelfRepository()) {
            self.repository = repository
        }

        func loadState(for bookId: String) {
            isOnTBR = repository.isOnShelf(bookId: bookId, shelf: .tbr)
            isOnRecommend = repository.isOnShelf(bookId: bookId, shelf: .recommend)
            isRead = repository.isOnShelf(bookId: bookId, shelf: .read)
        }

        func toggleTBR(bookId: String) {
            if isOnTBR {
                repository.removeFromShelf(bookId: bookId, shelf: .tbr)
            } else {
                repository.addToShelf(bookId: bookId, shelf: .tbr)
            }
            isOnTBR.toggle()
        }

        func toggleRecommend(bookId: String) {
            if isOnRecommend {
                repository.removeFromShelf(bookId: bookId, shelf: .recommend)
            } else {
                repository.addToShelf(bookId: bookId, shelf: .recommend)
            }
            isOnRecommend.toggle()
        }

        func toggleRead(bookId: String) {
            if isRead {
                repository.removeFromShelf(bookId: bookId, shelf: .read)
            } else {
                repository.addToShelf(bookId: bookId, shelf: .read)
            }
            isRead.toggle()
        }
    }
    ```

    Note: The shared module exposes BookShelf as Swift enum via KMP. Use .tbr, .recommend, .read (lowercase) as Kotlin enums are exposed that way.
  </action>
  <verify>Xcode build succeeds (xcodebuild -project iosApp/iosApp.xcodeproj -scheme iosApp -destination 'platform=iOS Simulator,name=iPhone 15' build)</verify>
  <done>ShelfViewModel manages shelf state with toggle actions</done>
</task>

<task type="auto">
  <name>Task 2: Create BookInfoSheet with book details and action buttons</name>
  <files>iosApp/iosApp/BookInfoSheet.swift</files>
  <action>
    Create BookInfoSheet as a slide-up sheet (following wireframe design):
    ```swift
    import SwiftUI
    import shared

    struct BookInfoSheet: View {
        let book: Book
        @StateObject private var shelfViewModel = ShelfViewModel()
        @Environment(\.dismiss) private var dismiss

        var body: some View {
            ScrollView {
                VStack(alignment: .leading, spacing: 16) {
                    // Small cover image centered at top
                    if let coverUrl = book.coverUrl, let url = URL(string: coverUrl) {
                        AsyncImage(url: url) { image in
                            image.resizable().aspectRatio(contentMode: .fit)
                        } placeholder: {
                            Color.gray.opacity(0.3)
                        }
                        .frame(height: 200)
                        .cornerRadius(8)
                        .frame(maxWidth: .infinity)
                    }

                    // Title and Author
                    Text(book.title)
                        .font(.title2)
                        .fontWeight(.bold)

                    Text(book.author)
                        .font(.subheadline)
                        .foregroundColor(.secondary)

                    // Pub date and genres
                    if let pubDate = book.publishedDate {
                        Text("Published: \(pubDate)")
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }

                    if !book.subjects.isEmpty {
                        Text(book.subjects.prefix(3).joined(separator: " â€¢ "))
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }

                    // Description
                    if let description = book.description_ {
                        Text(description)
                            .font(.body)
                            .lineLimit(nil)
                    }

                    Spacer().frame(height: 20)

                    // Action buttons grid (2x2)
                    LazyVGrid(columns: [GridItem(.flexible()), GridItem(.flexible())], spacing: 12) {
                        ActionButton(
                            title: "TBR",
                            icon: shelfViewModel.isOnTBR ? "heart.fill" : "heart",
                            isActive: shelfViewModel.isOnTBR
                        ) {
                            shelfViewModel.toggleTBR(bookId: book.id)
                        }

                        ActionButton(
                            title: "Recommend",
                            icon: shelfViewModel.isOnRecommend ? "star.fill" : "star",
                            isActive: shelfViewModel.isOnRecommend
                        ) {
                            shelfViewModel.toggleRecommend(bookId: book.id)
                        }

                        ActionButton(
                            title: "Read",
                            icon: shelfViewModel.isRead ? "checkmark.circle.fill" : "checkmark.circle",
                            isActive: shelfViewModel.isRead
                        ) {
                            shelfViewModel.toggleRead(bookId: book.id)
                        }

                        ActionButton(
                            title: "Buy",
                            icon: "cart",
                            isActive: false
                        ) {
                            openBuyOptions()
                        }
                    }
                }
                .padding()
            }
            .onAppear {
                shelfViewModel.loadState(for: book.id)
            }
        }

        private func openBuyOptions() {
            // Open Amazon search for book title + author
            let query = "\(book.title) \(book.author)".addingPercentEncoding(withAllowedCharacters: .urlQueryAllowed) ?? ""
            if let url = URL(string: "https://www.amazon.com/s?k=\(query)") {
                UIApplication.shared.open(url)
            }
        }
    }

    struct ActionButton: View {
        let title: String
        let icon: String
        let isActive: Bool
        let action: () -> Void

        var body: some View {
            Button(action: action) {
                VStack(spacing: 8) {
                    Image(systemName: icon)
                        .font(.title2)
                    Text(title)
                        .font(.caption)
                }
                .frame(maxWidth: .infinity)
                .padding(.vertical, 16)
                .background(isActive ? Color.accentColor.opacity(0.2) : Color.gray.opacity(0.1))
                .foregroundColor(isActive ? .accentColor : .primary)
                .cornerRadius(12)
            }
        }
    }
    ```

    Note: Kotlin `description` is exposed as `description_` in Swift due to naming conflict.
  </action>
  <verify>Xcode build succeeds</verify>
  <done>BookInfoSheet displays book details with 4 action buttons</done>
</task>

<task type="auto">
  <name>Task 3: Wire BookInfoSheet into BookFeedView with tap gesture</name>
  <files>iosApp/iosApp/BookFeedView.swift</files>
  <action>
    Update BookFeedView to show BookInfoSheet when user taps a book cover:

    1. Add @State for selected book and sheet presentation:
    ```swift
    @State private var selectedBook: Book? = nil
    @State private var showingInfo: Bool = false
    ```

    2. Add .onTapGesture to BookCoverCard to set selectedBook and show sheet:
    ```swift
    BookCoverCard(book: book, index: index, viewModel: viewModel)
        .containerRelativeFrame(.vertical)
        .onAppear { viewModel.onBookAppear(index: index) }
        .onTapGesture {
            selectedBook = book
            showingInfo = true
        }
    ```

    3. Add .sheet modifier to the main ZStack:
    ```swift
    .sheet(isPresented: $showingInfo) {
        if let book = selectedBook {
            BookInfoSheet(book: book)
                .presentationDetents([.medium, .large])
                .presentationDragIndicator(.visible)
        }
    }
    ```

    4. Update the TBR heart button in BookCoverCard to also use ShelfViewModel for visual state:
    - Add @StateObject shelfViewModel = ShelfViewModel() to BookCoverCard
    - Call shelfViewModel.loadState(for: book.id) in .onAppear
    - Use shelfViewModel.isOnTBR to show filled/unfilled heart
    - Call shelfViewModel.toggleTBR(bookId: book.id) on button tap
  </action>
  <verify>Xcode build succeeds</verify>
  <done>Tap on book cover opens info sheet, TBR button shows saved state</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>iOS book info panel with TBR/Recommend/Read/Buy actions</what-built>
  <how-to-verify>
    1. Open iosApp in Xcode and run on simulator (iPhone 15 or similar)
    2. Ensure you have a valid Google Books API key in FeedViewModel.swift
    3. Wait for books to load in the feed
    4. Tap on a book cover - info sheet should slide up
    5. Verify info sheet shows:
       - Book cover (smaller, centered)
       - Title and author
       - Description (if available)
       - 4 action buttons in 2x2 grid (TBR, Recommend, Read, Buy)
    6. Tap TBR button - should toggle to filled heart, button highlights
    7. Dismiss sheet, scroll to different book, come back - TBR state persists
    8. Tap Buy button - should open Amazon search in browser
    9. In feed, the heart button on a TBR'd book should show filled state
    10. Force quit and reopen app - TBR books should still show filled hearts
  </how-to-verify>
  <resume-signal>Type "approved" if iOS book info works correctly, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Xcode build succeeds without errors
- [ ] Tap on book cover shows info sheet
- [ ] Info sheet displays all book metadata
- [ ] All 4 action buttons are visible and tappable
- [ ] TBR/Recommend/Read buttons toggle state visually
- [ ] Buy button opens Amazon search
- [ ] TBR state persists in feed view
- [ ] TBR state persists across app restarts
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Human verified iOS info panel works correctly
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/04-book-info-actions/04-02-SUMMARY.md`
</output>
