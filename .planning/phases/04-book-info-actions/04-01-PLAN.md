---
phase: 04-book-info-actions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/browsy/data/model/BookShelf.kt
  - shared/src/commonMain/kotlin/com/browsy/data/model/SavedBook.kt
  - shared/src/commonMain/kotlin/com/browsy/data/repository/LocalBookShelfRepository.kt
  - shared/src/androidMain/kotlin/com/browsy/data/repository/LocalBookShelfStorage.android.kt
  - shared/src/iosMain/kotlin/com/browsy/data/repository/LocalBookShelfStorage.ios.kt
autonomous: true

must_haves:
  truths:
    - "Book can be saved to TBR shelf"
    - "Book can be saved to Recommend shelf"
    - "Book can be marked as Read"
    - "Saved books persist across app restarts"
    - "Book can be removed from shelf"
    - "Can check if book is on a specific shelf"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/browsy/data/model/BookShelf.kt"
      provides: "BookShelf enum (TBR, RECOMMEND, READ)"
    - path: "shared/src/commonMain/kotlin/com/browsy/data/model/SavedBook.kt"
      provides: "SavedBook data class (book reference + shelf + timestamp)"
    - path: "shared/src/commonMain/kotlin/com/browsy/data/repository/LocalBookShelfRepository.kt"
      provides: "Shelf operations (add, remove, check, list)"
  key_links:
    - from: "LocalBookShelfRepository"
      to: "platform storage"
      via: "expect/actual LocalBookShelfStorage"
      pattern: "expect.*LocalBookShelfStorage"
---

<objective>
Create local book shelf storage system for TBR/Recommend/Read actions.

Purpose: Enable users to save books to shelves that persist locally until backend sync is implemented in Phase 5-6. This provides immediate feedback and value before user accounts exist.

Output: BookShelf enum, SavedBook model, LocalBookShelfRepository with platform-specific persistence.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context
@.planning/phases/02-book-data-layer/02-04-SUMMARY.md

# Existing models and patterns
@shared/src/commonMain/kotlin/com/browsy/data/model/Book.kt
@shared/src/commonMain/kotlin/com/browsy/data/cache/BookCache.kt
@shared/src/androidMain/kotlin/com/browsy/data/cache/CurrentTimeMillis.android.kt
@shared/src/iosMain/kotlin/com/browsy/data/cache/CurrentTimeMillis.ios.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BookShelf enum and SavedBook model</name>
  <files>shared/src/commonMain/kotlin/com/browsy/data/model/BookShelf.kt, shared/src/commonMain/kotlin/com/browsy/data/model/SavedBook.kt</files>
  <action>
    Create BookShelf.kt with enum:
    ```kotlin
    enum class BookShelf {
        TBR,      // To Be Read - wishlist
        RECOMMEND, // User's public recommendations
        READ      // Books marked as read
    }
    ```

    Create SavedBook.kt data class:
    ```kotlin
    @Serializable
    data class SavedBook(
        val bookId: String,     // Reference to Book.id
        val shelf: BookShelf,
        val savedAt: Long       // Timestamp in millis
    )
    ```

    Both files should be in com.browsy.data.model package. Use @Serializable for SavedBook to enable JSON persistence.
  </action>
  <verify>./gradlew :shared:compileKotlinMetadata completes without errors</verify>
  <done>BookShelf enum and SavedBook model exist and compile</done>
</task>

<task type="auto">
  <name>Task 2: Create LocalBookShelfRepository with platform persistence</name>
  <files>shared/src/commonMain/kotlin/com/browsy/data/repository/LocalBookShelfRepository.kt, shared/src/androidMain/kotlin/com/browsy/data/repository/LocalBookShelfStorage.android.kt, shared/src/iosMain/kotlin/com/browsy/data/repository/LocalBookShelfStorage.ios.kt</files>
  <action>
    Create expect/actual pattern for platform-specific storage:

    **commonMain - LocalBookShelfStorage.kt:**
    ```kotlin
    internal expect class LocalBookShelfStorage() {
        fun save(data: String)
        fun load(): String?
    }
    ```

    **androidMain - LocalBookShelfStorage.android.kt:**
    Use SharedPreferences via applicationContext. Since we don't have DI, use a singleton pattern with lazy initialization that gets context from Android app.

    Note: For MVP simplicity, use a companion object that stores the context reference. The Android app will call `LocalBookShelfStorage.init(context)` on startup.
    ```kotlin
    actual class LocalBookShelfStorage {
        actual fun save(data: String) { prefs.edit().putString(KEY, data).apply() }
        actual fun load(): String? = prefs.getString(KEY, null)

        companion object {
            private const val KEY = "book_shelves"
            private lateinit var prefs: SharedPreferences
            fun init(context: Context) { prefs = context.getSharedPreferences("browsy", Context.MODE_PRIVATE) }
        }
    }
    ```

    **iosMain - LocalBookShelfStorage.ios.kt:**
    Use NSUserDefaults:
    ```kotlin
    actual class LocalBookShelfStorage {
        private val defaults = NSUserDefaults.standardUserDefaults
        actual fun save(data: String) { defaults.setObject(data, "book_shelves") }
        actual fun load(): String? = defaults.stringForKey("book_shelves")
    }
    ```

    **commonMain - LocalBookShelfRepository.kt:**
    ```kotlin
    class LocalBookShelfRepository(
        private val storage: LocalBookShelfStorage = LocalBookShelfStorage()
    ) {
        private val json = Json { ignoreUnknownKeys = true }
        private var cache: MutableMap<String, SavedBook> = mutableMapOf()

        init { loadFromStorage() }

        fun addToShelf(bookId: String, shelf: BookShelf) {
            val saved = SavedBook(bookId, shelf, currentTimeMillis())
            cache[cacheKey(bookId, shelf)] = saved
            persist()
        }

        fun removeFromShelf(bookId: String, shelf: BookShelf) {
            cache.remove(cacheKey(bookId, shelf))
            persist()
        }

        fun isOnShelf(bookId: String, shelf: BookShelf): Boolean =
            cache.containsKey(cacheKey(bookId, shelf))

        fun getShelf(shelf: BookShelf): List<SavedBook> =
            cache.values.filter { it.shelf == shelf }.sortedByDescending { it.savedAt }

        fun getShelves(bookId: String): List<BookShelf> =
            BookShelf.entries.filter { isOnShelf(bookId, it) }

        private fun cacheKey(bookId: String, shelf: BookShelf) = "$bookId:$shelf"

        private fun loadFromStorage() {
            storage.load()?.let { data ->
                val list = json.decodeFromString<List<SavedBook>>(data)
                cache = list.associateBy { cacheKey(it.bookId, it.shelf) }.toMutableMap()
            }
        }

        private fun persist() {
            val data = json.encodeToString(cache.values.toList())
            storage.save(data)
        }
    }
    ```

    Reuse the existing currentTimeMillis() expect/actual from BookCache.
  </action>
  <verify>./gradlew :shared:build completes without errors</verify>
  <done>LocalBookShelfRepository exists with add/remove/check/list operations and platform persistence</done>
</task>

<task type="auto">
  <name>Task 3: Initialize storage in Android app</name>
  <files>androidApp/src/main/java/com/browsy/android/BrowsyApplication.kt, androidApp/src/main/AndroidManifest.xml</files>
  <action>
    Create BrowsyApplication.kt:
    ```kotlin
    class BrowsyApplication : Application() {
        override fun onCreate() {
            super.onCreate()
            LocalBookShelfStorage.init(applicationContext)
        }
    }
    ```

    Update AndroidManifest.xml to use the application class:
    Add `android:name=".BrowsyApplication"` to the application tag.
  </action>
  <verify>./gradlew :androidApp:assembleDebug completes without errors</verify>
  <done>Android app initializes LocalBookShelfStorage on startup</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ./gradlew :shared:build succeeds
- [ ] ./gradlew :androidApp:assembleDebug succeeds
- [ ] BookShelf enum has TBR, RECOMMEND, READ values
- [ ] SavedBook is @Serializable
- [ ] LocalBookShelfRepository has add, remove, isOnShelf, getShelf methods
- [ ] Android SharedPreferences storage implemented
- [ ] iOS NSUserDefaults storage implemented
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Local shelf storage ready for UI integration in Plans 02/03
</success_criteria>

<output>
After completion, create `.planning/phases/04-book-info-actions/04-01-SUMMARY.md`
</output>
