---
phase: 02-book-data-layer
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - shared/src/commonMain/kotlin/com/browsy/data/remote/GoogleBooksApi.kt
  - shared/src/commonMain/kotlin/com/browsy/data/remote/dto/GoogleBooksDto.kt
  - shared/src/commonMain/kotlin/com/browsy/data/remote/mapper/GoogleBooksMapper.kt
autonomous: true
user_setup:
  - service: google-books-api
    why: "API key required for Google Books API requests"
    env_vars:
      - name: GOOGLE_BOOKS_API_KEY
        source: "Google Cloud Console → APIs & Services → Credentials → Create API Key → Restrict to Books API"
    account_setup:
      - url: "https://console.cloud.google.com/"
        skip_if: "Already have Google Cloud account"
    dashboard_config:
      - task: "Enable Google Books API"
        location: "Google Cloud Console → APIs & Services → Library → Search 'Books API' → Enable"
        details: "Enable the Books API for your project"
      - task: "Create API Key"
        location: "Google Cloud Console → APIs & Services → Credentials"
        details: "Create API Key, restrict to Books API for security"
    local_dev:
      - "Add GOOGLE_BOOKS_API_KEY=your_key_here to local.properties (gitignored)"
---

<objective>
Implement Google Books API client with Ktor, including DTOs, mappers, and search functionality.

Purpose: Primary book data source with reliable metadata and cover images
Output: Working Google Books integration that can search books and map responses to Book model
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-book-data-layer/DISCOVERY.md
@.planning/phases/02-book-data-layer/02-01-SUMMARY.md

# Data models from Plan 01:
@shared/src/commonMain/kotlin/com/browsy/data/model/Book.kt
@shared/src/commonMain/kotlin/com/browsy/data/model/BookCover.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Google Books API DTOs</name>
  <files>shared/src/commonMain/kotlin/com/browsy/data/remote/dto/GoogleBooksDto.kt</files>
  <action>
Create data transfer objects for Google Books API responses in com.browsy.data.remote.dto package:

```kotlin
@Serializable
data class GoogleBooksResponse(
    val items: List&lt;VolumeItem&gt;? = null,
    val totalItems: Int = 0
)

@Serializable
data class VolumeItem(
    val id: String,
    val volumeInfo: VolumeInfo
)

@Serializable
data class VolumeInfo(
    val title: String,
    val authors: List&lt;String&gt;? = null,
    val description: String? = null,
    val publishedDate: String? = null,
    val pageCount: Int? = null,
    val categories: List&lt;String&gt;? = null,
    val imageLinks: ImageLinks? = null,
    val industryIdentifiers: List&lt;IndustryIdentifier&gt;? = null
)

@Serializable
data class ImageLinks(
    val thumbnail: String? = null,
    val smallThumbnail: String? = null,
    val small: String? = null,
    val medium: String? = null,
    val large: String? = null,
    val extraLarge: String? = null
)

@Serializable
data class IndustryIdentifier(
    val type: String, // "ISBN_10" or "ISBN_13"
    val identifier: String
)
```

All fields nullable or with defaults to handle partial API responses gracefully.
Add KDoc explaining these mirror Google Books API structure.
  </action>
  <verify>./gradlew :shared:build compiles DTOs without errors</verify>
  <done>Google Books DTOs defined and serializable</done>
</task>

<task type="auto">
  <name>Task 2: Create Google Books API client</name>
  <files>shared/src/commonMain/kotlin/com/browsy/data/remote/GoogleBooksApi.kt</files>
  <action>
Create GoogleBooksApi class in com.browsy.data.remote package:

```kotlin
class GoogleBooksApi(private val apiKey: String) {
    private val client = HttpClient {
        install(ContentNegotiation) {
            json(Json {
                ignoreUnknownKeys = true
                isLenient = true
            })
        }
    }

    private val baseUrl = "https://www.googleapis.com/books/v1/volumes"

    suspend fun searchBooks(
        query: String,
        maxResults: Int = 20
    ): Result&lt;GoogleBooksResponse&gt; {
        return try {
            val response = client.get(baseUrl) {
                parameter("q", query)
                parameter("maxResults", maxResults)
                parameter("key", apiKey)
            }.body&lt;GoogleBooksResponse&gt;()
            Result.success(response)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    suspend fun getBookByIsbn(isbn: String): Result&lt;GoogleBooksResponse&gt; {
        return searchBooks("isbn:$isbn", maxResults = 1)
    }

    fun close() {
        client.close()
    }
}
```

Use Result type for error handling without throwing exceptions.
Add KDoc for each method explaining parameters and return types.
  </action>
  <verify>./gradlew :shared:build compiles API client successfully</verify>
  <done>GoogleBooksApi client can search books and fetch by ISBN</done>
</task>

<task type="auto">
  <name>Task 3: Create mapper from Google Books DTO to Book model</name>
  <files>shared/src/commonMain/kotlin/com/browsy/data/remote/mapper/GoogleBooksMapper.kt</files>
  <action>
Create GoogleBooksMapper object in com.browsy.data.remote.mapper package with extension functions:

```kotlin
object GoogleBooksMapper {
    fun VolumeItem.toBook(): Book {
        val info = volumeInfo
        return Book(
            id = id,
            title = info.title,
            author = info.authors?.firstOrNull() ?: "Unknown Author",
            coverUrl = info.imageLinks?.large
                ?: info.imageLinks?.medium
                ?: info.imageLinks?.thumbnail,
            description = info.description,
            publishedDate = info.publishedDate,
            pageCount = info.pageCount,
            isbn = extractIsbn13(info.industryIdentifiers)
                ?: extractIsbn10(info.industryIdentifiers),
            subjects = info.categories.orEmpty()
        )
    }

    private fun extractIsbn13(identifiers: List&lt;IndustryIdentifier&gt;?): String? {
        return identifiers?.firstOrNull { it.type == "ISBN_13" }?.identifier
    }

    private fun extractIsbn10(identifiers: List&lt;IndustryIdentifier&gt;?): String? {
        return identifiers?.firstOrNull { it.type == "ISBN_10" }?.identifier
    }
}
```

Prefer larger cover images (large → medium → thumbnail).
Prefer ISBN-13 over ISBN-10.
Handle missing authors gracefully with "Unknown Author".
Add KDoc explaining mapping logic and fallback strategies.
  </action>
  <verify>./gradlew :shared:build compiles mapper successfully</verify>
  <done>Mapper transforms Google Books DTOs to Book domain model with sensible defaults</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ./gradlew :shared:build succeeds without errors
- [ ] All DTOs are @Serializable and handle optional fields
- [ ] GoogleBooksApi uses Ktor client with JSON content negotiation
- [ ] Mapper correctly transforms VolumeItem to Book model
- [ ] Error handling uses Result type consistently
</verification>

<success_criteria>
- All tasks completed
- Google Books API client can search and fetch books
- DTOs mirror API response structure with safe defaults
- Mapper produces valid Book instances from API responses
- API key is externalized (not hardcoded)
- User setup documentation created for API key configuration
</success_criteria>

<output>
After completion, create `.planning/phases/02-book-data-layer/02-02-SUMMARY.md`
</output>
