---
phase: 02-book-data-layer
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - shared/src/commonMain/kotlin/com/browsy/data/remote/OpenLibraryApi.kt
  - shared/src/commonMain/kotlin/com/browsy/data/remote/dto/OpenLibraryDto.kt
  - shared/src/commonMain/kotlin/com/browsy/data/remote/mapper/OpenLibraryMapper.kt
autonomous: true
---

<objective>
Implement Open Library API client as fallback data source, including DTOs, mappers, and ISBN search.

Purpose: Backup book data source when Google Books has no results or missing covers
Output: Working Open Library integration that fetches book metadata and constructs cover URLs
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-book-data-layer/DISCOVERY.md
@.planning/phases/02-book-data-layer/02-01-SUMMARY.md

# Data models from Plan 01:
@shared/src/commonMain/kotlin/com/browsy/data/model/Book.kt
@shared/src/commonMain/kotlin/com/browsy/data/model/BookCover.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Open Library API DTOs</name>
  <files>shared/src/commonMain/kotlin/com/browsy/data/remote/dto/OpenLibraryDto.kt</files>
  <action>
Create DTOs for Open Library API in com.browsy.data.remote.dto package:

```kotlin
@Serializable
data class OpenLibraryResponse(
    // Dynamic key based on bibkey (e.g., "ISBN:0451526538")
    // Use JsonElement to handle dynamic keys, then extract in mapper
    val data: JsonObject
)

@Serializable
data class OpenLibraryBookData(
    val title: String,
    val subtitle: String? = null,
    val authors: List&lt;Author&gt;? = null,
    val publishers: List&lt;Publisher&gt;? = null,
    @SerialName("publish_date")
    val publishDate: String? = null,
    @SerialName("number_of_pages")
    val numberOfPages: Int? = null,
    val subjects: List&lt;Subject&gt;? = null,
    val cover: Cover? = null,
    val identifiers: Identifiers? = null
)

@Serializable
data class Author(
    val name: String,
    val url: String? = null
)

@Serializable
data class Publisher(
    val name: String
)

@Serializable
data class Subject(
    val name: String,
    val url: String? = null
)

@Serializable
data class Cover(
    val small: String? = null,
    val medium: String? = null,
    val large: String? = null
)

@Serializable
data class Identifiers(
    val isbn_13: List&lt;String&gt;? = null,
    val isbn_10: List&lt;String&gt;? = null,
    val oclc: List&lt;String&gt;? = null,
    val lccn: List&lt;String&gt;? = null
)
```

Add KDoc explaining Open Library response structure and dynamic key handling.
Use @SerialName for snake_case fields.
  </action>
  <verify>./gradlew :shared:build compiles DTOs successfully</verify>
  <done>Open Library DTOs defined with proper JSON mapping</done>
</task>

<task type="auto">
  <name>Task 2: Create Open Library API client</name>
  <files>shared/src/commonMain/kotlin/com/browsy/data/remote/OpenLibraryApi.kt</files>
  <action>
Create OpenLibraryApi class in com.browsy.data.remote package:

```kotlin
class OpenLibraryApi {
    private val client = HttpClient {
        install(ContentNegotiation) {
            json(Json {
                ignoreUnknownKeys = true
                isLenient = true
            })
        }
    }

    private val booksUrl = "https://openlibrary.org/api/books"
    private val coversUrl = "https://covers.openlibrary.org/b"

    suspend fun getBookByIsbn(isbn: String): Result&lt;OpenLibraryBookData?&gt; {
        return try {
            val bibkey = "ISBN:$isbn"
            val response = client.get(booksUrl) {
                parameter("bibkeys", bibkey)
                parameter("format", "json")
                parameter("jscmd", "data")
            }.body&lt;JsonObject&gt;()

            // Extract book data from dynamic key
            val bookData = response[bibkey]?.let { element ->
                Json.decodeFromJsonElement&lt;OpenLibraryBookData&gt;(element)
            }

            Result.success(bookData)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    fun getCoverUrl(isbn: String, size: String = "L"): String {
        // size: S (small), M (medium), L (large)
        return "$coversUrl/isbn/$isbn-$size.jpg"
    }

    fun close() {
        client.close()
    }
}
```

No API key required for Open Library.
Use Result type for consistent error handling.
Provide separate cover URL generation method.
Add KDoc explaining ISBN lookup and cover URL construction.
  </action>
  <verify>./gradlew :shared:build compiles API client successfully</verify>
  <done>OpenLibraryApi client can fetch book data by ISBN and generate cover URLs</done>
</task>

<task type="auto">
  <name>Task 3: Create mapper from Open Library DTO to Book model</name>
  <files>shared/src/commonMain/kotlin/com/browsy/data/remote/mapper/OpenLibraryMapper.kt</files>
  <action>
Create OpenLibraryMapper object in com.browsy.data.remote.mapper package:

```kotlin
object OpenLibraryMapper {
    fun OpenLibraryBookData.toBook(isbn: String): Book {
        return Book(
            id = "OL:$isbn",
            title = if (subtitle != null) "$title: $subtitle" else title,
            author = authors?.firstOrNull()?.name ?: "Unknown Author",
            coverUrl = cover?.large ?: cover?.medium ?: cover?.small,
            description = null, // Open Library doesn't provide description in Books API
            publishedDate = publishDate,
            pageCount = numberOfPages,
            isbn = identifiers?.isbn_13?.firstOrNull()
                ?: identifiers?.isbn_10?.firstOrNull()
                ?: isbn,
            subjects = subjects?.map { it.name }.orEmpty()
        )
    }
}
```

Combine title and subtitle with colon separator.
Use "OL:" prefix for IDs to distinguish from Google Books.
Prefer ISBN-13 from identifiers, fall back to query ISBN.
Extract subject names from Subject objects.
Add KDoc explaining Open Library-specific mapping logic.
  </action>
  <verify>./gradlew :shared:build compiles mapper successfully</verify>
  <done>Mapper transforms Open Library data to Book model with appropriate handling</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ./gradlew :shared:build succeeds without errors
- [ ] Open Library DTOs handle jscmd=data response structure
- [ ] API client correctly extracts data from dynamic JSON keys
- [ ] Cover URL generation follows Open Library Covers API format
- [ ] Mapper produces valid Book instances with "OL:" ID prefix
</verification>

<success_criteria>
- All tasks completed
- Open Library API client can fetch books by ISBN
- DTOs handle dynamic response keys and nested structures
- Mapper produces Book model instances
- Cover URL generation works for all sizes (S, M, L)
- No API key required (free public API)
</success_criteria>

<output>
After completion, create `.planning/phases/02-book-data-layer/02-03-SUMMARY.md`
</output>
