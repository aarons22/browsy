---
phase: 05-backend-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [
  backend/package.json,
  backend/src/app.ts,
  backend/Dockerfile,
  backend/.dockerignore,
  backend/tsconfig.json,
  .gcloudignore,
  .gitignore
]
autonomous: true
user_setup:
  - service: gcp
    why: "Cloud Run deployment and Firestore database"
    env_vars:
      - name: GOOGLE_APPLICATION_CREDENTIALS
        source: "GCP Console -> IAM & Admin -> Service Accounts -> Create key (JSON)"
      - name: GOOGLE_CLOUD_PROJECT
        source: "GCP Console -> Project settings -> Project ID"
    account_setup:
      - task: "Create GCP account and billing setup"
        location: "https://cloud.google.com/"
    dashboard_config:
      - task: "Create new GCP project"
        location: "GCP Console -> Select a project -> New Project"
      - task: "Enable Cloud Run API"
        location: "GCP Console -> APIs & Services -> Library -> Cloud Run"
      - task: "Enable Firestore API"
        location: "GCP Console -> APIs & Services -> Library -> Cloud Firestore"
      - task: "Create service account for local development"
        location: "GCP Console -> IAM & Admin -> Service Accounts"

must_haves:
  truths:
    - "Node.js backend server can start and respond to health checks"
    - "Docker container builds successfully"
    - "GCP project has required APIs enabled"
  artifacts:
    - path: "backend/src/app.ts"
      provides: "Express server with health endpoint"
      min_lines: 20
    - path: "backend/package.json"
      provides: "Node.js dependencies"
      contains: "express"
    - path: "backend/Dockerfile"
      provides: "Multi-stage Docker build"
      contains: "FROM node"
  key_links:
    - from: "backend/src/app.ts"
      to: "express framework"
      via: "import express"
      pattern: "import.*express"
    - from: "backend/Dockerfile"
      to: "backend/package.json"
      via: "COPY package*.json"
      pattern: "COPY package.*json"
---

<objective>
Establish GCP project foundation and Node.js backend structure for Browsy mobile app.

Purpose: Create the cloud infrastructure foundation and containerized Express.js backend that will serve the mobile app's user data persistence needs.
Output: GCP project with enabled APIs and runnable Node.js backend in Docker container
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-backend-infrastructure/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Node.js Backend Foundation</name>
  <files>
    backend/package.json
    backend/src/app.ts
    backend/tsconfig.json
    backend/.gitignore
  </files>
  <action>
    Create backend directory with Node.js 18+ Express.js foundation following research recommendations:

    1. Initialize package.json with dependencies:
       - express (4.18+), cors, helmet, compression
       - firebase-admin (11.x), @google-cloud/secret-manager (4.x)
       - Dev: @types/express, @types/cors, typescript, ts-node

    2. Create src/app.ts with Express server:
       - Basic Express setup with security middleware (helmet, cors)
       - Health check endpoint at GET /health
       - JSON parsing middleware
       - Port from process.env.PORT || 8080 (Cloud Run requirement)
       - Console logging on startup

    3. Configure TypeScript with tsconfig.json for Node.js 18 target
    4. Create backend/.gitignore for node_modules, dist, .env files

    Follow research patterns exactly - this establishes the foundation for Firestore integration.
  </action>
  <verify>cd backend && npm install && npm run dev</verify>
  <done>Backend server starts on port 8080 and GET /health returns {"status": "healthy"}</done>
</task>

<task type="auto">
  <name>Task 2: Create Docker Container Setup</name>
  <files>
    backend/Dockerfile
    backend/.dockerignore
    .gcloudignore
  </files>
  <action>
    Create Docker multi-stage build optimized for Cloud Run following research recommendations:

    1. Create backend/Dockerfile with multi-stage build:
       - Build stage: node:18-alpine, COPY package*.json, RUN npm ci --only=production
       - Runtime stage: node:18-alpine, copy node_modules and source
       - EXPOSE 8080, CMD ["npm", "start"]
       - Include WORKDIR /app in both stages

    2. Create backend/.dockerignore:
       - node_modules, npm-debug.log, .git, .env files
       - Optimize build context size for faster Cloud Run deployments

    3. Update root .gitignore to exclude backend build artifacts if not already present

    4. Create .gcloudignore at project root for Cloud Run deployments:
       - Exclude .git, node_modules, local config files
       - Include only backend/ directory contents for deployment

    Follow research multi-stage pattern exactly to optimize cold start performance.
  </action>
  <verify>cd backend && docker build -t browsy-backend . && docker run --rm -p 8080:8080 browsy-backend</verify>
  <done>Docker container builds successfully and backend server accessible at localhost:8080/health</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Set up GCP project and enable required services</action>
  <instructions>
    Complete the following GCP setup steps:

    1. **Create GCP Account & Project:**
       - Visit https://cloud.google.com/
       - Create account and set up billing if needed
       - Create new project: "browsy-backend" (or similar)
       - Note the Project ID for environment variables

    2. **Enable Required APIs:**
       - Go to APIs & Services → Library
       - Enable "Cloud Run API"
       - Enable "Cloud Firestore API"
       - Enable "Secret Manager API"

    3. **Create Service Account:**
       - Go to IAM & Admin → Service Accounts
       - Create service account: "browsy-backend-dev"
       - Grant roles: "Cloud Run Developer", "Firebase Admin"
       - Create JSON key for local development
       - Download and save securely (DO NOT commit to git)

    4. **Set Environment Variables:**
       - Create backend/.env file with:
         ```
         GOOGLE_CLOUD_PROJECT=your-project-id
         GOOGLE_APPLICATION_CREDENTIALS=path/to/service-account-key.json
         ```

    This enables Cloud Run deployment and Firestore access for the next plans.
  </instructions>
  <resume-signal>Reply "gcp-setup-complete" when all APIs are enabled and service account is created</resume-signal>
</task>

</tasks>

<verification>
- [ ] Node.js backend runs locally with health endpoint
- [ ] Docker container builds and runs successfully
- [ ] GCP project exists with Cloud Run and Firestore APIs enabled
- [ ] Service account created with appropriate roles
- [ ] Environment variables configured for local development
</verification>

<success_criteria>
- Backend server responds to health checks locally and in Docker
- GCP infrastructure ready for Firestore integration and Cloud Run deployment
- Container optimized for Cloud Run cold start performance
- Local development environment configured with GCP credentials
</success_criteria>

<output>
After completion, create `.planning/phases/05-backend-infrastructure/05-01-SUMMARY.md`
</output>