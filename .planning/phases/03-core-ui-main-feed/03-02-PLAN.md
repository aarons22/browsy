---
phase: 03-core-ui-main-feed
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [androidApp/src/main/java/com/browsy/android/ui/feed/BookFeedScreen.kt, androidApp/src/main/java/com/browsy/android/ui/feed/FeedViewModel.kt, androidApp/src/main/java/com/browsy/android/MainActivity.kt]
autonomous: true
---

<objective>
Implement Android book feed with VerticalPager, high-quality cover display, and infinite scroll.

Purpose: Deliver the core browsing experience for Android using Compose Foundation VerticalPager. Priority #1 is visual quality - covers must be crisp and beautiful. Snap-to-position and smooth transitions follow.

Output: Working Android book feed with TikTok-style vertical swipe, snap behavior, and seamless pagination.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-ui-main-feed/03-CONTEXT.md
@.planning/phases/03-core-ui-main-feed/03-RESEARCH.md
@shared/src/commonMain/kotlin/com/browsy/data/model/Book.kt
@shared/src/commonMain/kotlin/com/browsy/data/repository/BookRepository.kt
@androidApp/src/main/java/com/browsy/android/MainActivity.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FeedViewModel for book state and pagination</name>
  <files>androidApp/src/main/java/com/browsy/android/ui/feed/FeedViewModel.kt</files>
  <action>
Create FeedViewModel extending ViewModel to manage book loading and pagination.

**Implementation:**
- private val repository = BookRepository.create(apiKey = "YOUR_API_KEY_HERE")
- private val _books = MutableStateFlow<List<Book>>(emptyList())
- val books: StateFlow<List<Book>> = _books.asStateFlow()
- private val _isLoading = MutableStateFlow(false)
- val isLoading: StateFlow<Boolean> = _isLoading.asStateFlow()
- private var currentPage = 0
- private val pageSize = 20
- private val prefetchDistance = 5

**Methods:**
- `init { loadInitialBooks() }` - Automatically loads first page on creation
- `private fun loadInitialBooks()` - viewModelScope.launch, calls repository.searchBooks("fantasy", 0, pageSize)
- `fun loadMoreBooks()` - Increments page, loads next batch, appends to _books
- `fun onBookAppear(index: Int)` - If index >= books.size - prefetchDistance && !isLoading, call loadMoreBooks()

**Error handling (from RESEARCH.md common pitfalls):**
- Use isLoading flag to prevent concurrent pagination requests
- Wrap repository calls in try-catch
- Log errors to console (proper error UI in Phase 4)

**Quality priority (from CONTEXT.md):**
- No image downsampling in ViewModel
- Repository returns coverUrls, AsyncImage handles loading with full quality

**Note on API key:**
Google Books API key hardcoded for now (user provides their own). Phase 5 adds secrets management.
  </action>
  <verify>
Build succeeds. Code compiles without errors. ViewModel structure matches pattern.
  </verify>
  <done>
- FeedViewModel.kt exists in androidApp/ui/feed package
- StateFlow pattern for reactive book list
- Pagination logic with 5-book prefetch
- isLoading flag prevents race conditions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BookFeedScreen with VerticalPager</name>
  <files>androidApp/src/main/java/com/browsy/android/ui/feed/BookFeedScreen.kt</files>
  <action>
Create BookFeedScreen composable using official VerticalPager from compose.foundation (RESEARCH.md: Accompanist Pager deprecated).

**Implementation:**
- `@Composable fun BookFeedScreen(viewModel: FeedViewModel = viewModel())`
- Collect books with `val books by viewModel.books.collectAsState()`
- Create `val pagerState = rememberPagerState(pageCount = { books.size })`
- Use VerticalPager with:
  - `state = pagerState`
  - `pageSpacing = 0.dp` (RESEARCH.md: prevents scroll offset issues)
  - `beyondBoundsPageCount = 1` (preload adjacent page for smooth scroll)
  - `key = { books[it].id }` (stable IDs prevent recomposition issues)
  - `modifier = Modifier.fillMaxSize()`

**Each page content:**
- Box(modifier = Modifier.fillMaxSize()) containing:
  - AsyncImage for book cover with:
    - `model = books[page].coverUrl`
    - `contentScale = ContentScale.Crop` (fill screen, maintain aspect)
    - `modifier = Modifier.fillMaxSize()`
  - Overlay gradient at bottom (Box with linear gradient, transparent to black)
  - Text overlays in overlay Box:
    - Title: style = MaterialTheme.typography.titleLarge, color = White
    - Author: style = MaterialTheme.typography.bodyMedium, color = White.copy(alpha = 0.8f)
  - FloatingActionButton for TBR (heart icon, top-right corner):
    - Icon(Icons.Default.Favorite)
    - onClick = {} (non-functional for now - Phase 4)

**Pagination trigger (from RESEARCH.md):**
- LaunchedEffect(pagerState.currentPage) monitoring page changes
- When currentPage changes, call viewModel.onBookAppear(pagerState.currentPage)
- ViewModel handles shouldLoadMore logic internally

**Quality settings (from CONTEXT.md + RESEARCH.md):**
- AsyncImage with no size parameter = uses original image quality
- ContentScale.Crop maintains aspect ratio without distortion
- No manual downsampling - Coil handles efficiently

**Why VerticalPager:**
Official Compose Foundation component (androidx.compose.foundation >= 1.4), replaces deprecated Accompanist Pager. Handles snap behavior, fling physics, and accessibility automatically.
  </action>
  <verify>
Build succeeds. Run on Android emulator/device. Verify:
- Full-screen book covers display
- Vertical swipe changes books with snap
- Covers are crisp and fill screen
- Title/author overlay visible
- Heart FAB visible (non-functional OK)
  </verify>
  <done>
- BookFeedScreen.kt exists with VerticalPager
- ViewModel integrated via collectAsState
- AsyncImage displays high-quality covers
- Snap-to-position works (VerticalPager default)
- Pagination triggers at 5 books from end
- Title/author overlay present
- TBR FAB visible (Phase 4 implements functionality)
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate BookFeedScreen into MainActivity</name>
  <files>androidApp/src/main/java/com/browsy/android/MainActivity.kt</files>
  <action>
Update MainActivity to show BookFeedScreen instead of Greeting placeholder.

**Implementation:**
- In setContent block, replace the Box with Text(Greeting().greet()) with:
  - BookFeedScreen() directly in BrowsyTheme Surface
- Remove Box + Greeting import (keep for future use elsewhere)
- Keep BrowsyTheme wrapper for Material3 theming

**Simple integration:**
```kotlin
setContent {
    BrowsyTheme {
        Surface(
            modifier = Modifier.fillMaxSize(),
            color = MaterialTheme.colorScheme.background
        ) {
            BookFeedScreen()
        }
    }
}
```

No navigation structure yet - Phase 4 adds bottom nav and screens.
  </action>
  <verify>
Build and run on Android emulator or device. App opens directly to book feed, no "Hello" placeholder.
  </verify>
  <done>
- MainActivity.kt shows BookFeedScreen as root
- App launches into book browsing experience
- No navigation chrome yet (intentional - Phase 4)
- Build succeeds, runtime stable
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew assembleDebug` succeeds
- [ ] Android app runs without crashes
- [ ] Book covers display full-screen and crisp
- [ ] Vertical swipe changes books with snap
- [ ] Pagination loads more books automatically
- [ ] Title/author overlay visible
- [ ] TBR FAB visible (non-functional OK)
- [ ] No memory leaks (verified via Android Profiler if available)
</verification>

<success_criteria>
- All tasks completed
- Android app shows vertical book feed on launch
- Covers are high-quality and full-screen
- Snap-to-position works (VerticalPager default)
- Infinite scroll pagination working
- No build errors or runtime crashes
- Memory usage stable during scrolling
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-ui-main-feed/03-02-SUMMARY.md`
</output>
